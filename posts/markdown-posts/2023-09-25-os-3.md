---
date: 2023-09-25
title: 作業系統筆記 (3)
subtitle: OS Structure
category: personal-note
frontCover: https://www.ionos.com/digitalguide/fileadmin/DigitalGuide/Teaser/operating-system-t.jpg
tag: personal-note, courses, os
---
### OS services
- User interface
- Program Execution
- I/O operations
- File-system manipulation
- Communication
  - 不同電腦的 network 溝通
  - 同一台電腦 process 之間的溝通
- Error detection
- Resource allocation
  - 確保電腦不會被某支程式拖累
- Accounting
- Protection and security

#### User interface
- CLI (Command Line Interface)
  - Fetches a command from user and executes it
  - **Shell: Command-line interpreter** (CSHELL, BASH)
    - Adjusted according to user behavior and preference
    - ex: 有些人喜歡 ls，有些人喜歡 dir、字體顏色
- GUI (Graphic User Interface)
  - Usually mouse, keyboard, and monitor
  - Icons represent files, programs, actions, etc
  - Various mouse buttons over objects in the interface cause various actions
- Most systems hav both **CLI** and **GUI**

### Communication Models
- Communication may take place using either **message passing** or **shared memory**
- message passing
  - 因為 protection，需要透過 OS 來 copy (system call)
  - 會比較慢
- shared memory
  - 透過 system call，事前建立 shared memory，預設是沒有的
  - multi-thread programming 一開始就有 shared memory
  - deadlock synchronization
```img
communication.png
```
### OS-Application Interface
#### Basic Introduction
- System calls
  - The **OS interface** to a running program
    - part of OS
  - An explicit request to the **kernel** made via a **software interface**
  - Generally available as **assembly-language** instructions
    - 才夠快
- API
  - **Users mostly program against API instead of system call**
  - Commonly implemented by language libraries, e.g., **C Library**
    - 大部分作業系統 API 是用 C
    - Android 是 Java
  - An API call should involve **zero or multiple system call**
    - Both malloc() and free() use system call brk()
    - fopen() 要很多 system call 
    - Math API functions, such as abs(), don't need to involve system call
```img
os-application.png
```
#### System calls
- Request OS services
  - Process control
    - abort, create, terminate process, allocate/free memory
  - File management
    - create, delete, open, close file
  - Device management
    - read, write, reposition device
  - Information maintenance
    - get time or date
  - Communications
    - send receive message
- **Three general methods** are used to pass parameters between a running program and the operating system  
  - pass parameters in **registers**
  - store the parameters in a **table in memory**, and the table address is passed as a parameter in a register
    - pointer of data structure 
  - Push (store) the parameters onto the **stack** by the program and pop off the stack by operating system
#### API
- Three most common APIs
  - **Win32 API** for **Windows**
  - **POSIX API** for POSIX-based systems (including virtually all versions of UNIX, Linux, and Mac OS X)
    - POSIX (Portable Operating System Interface for Unix)
    - system calls 不一樣，但是 API 的定義一樣，確保同個程式碼可以在不同作業系統運行，所以叫做 portable
  - **Java API** for the Java virtual machine (JVM)
    - run 在自己虛擬的 virtual machine 上，不管下面真實的 machine 是什麼，probability 更好
    - 比較慢
- Features
  - Simplicity
    - API is designed for applications
  - Portability
    - API is an unified defined interface
  - **Efficiency**
    - Not all functions require OS services or involve kernel
    - 幫你寫好最有效率的底層語言
  
### System Structure
- User goals 
  - operating system should be **easy to use** and **learn**, as well as **reliable**, **safe** and **fast**
    - interactive 的 fast (time-sharing)
- System goals
  - operating system should be **easy to design**, **implement** and **maintain**, as well as **reliable**, **error-free**, and **efficient**

#### Simple OS Architecture
- Only one or two levels of code
- Drawbacks
  - Unsafe, difficult to enhance
```img
simple-os-architecture.png
```

#### Layer OS Architecture
- Lower levels independent of upper levels
  - Nth layer can only access services provided by 0 ~ (N-1)th layer
- Pros
  - Easier debugging / maintenance
- Cons
  - Less efficiency, difficult to define layers
    - layer 之間會需要很多 copy
```img
layer-os-architecture.png
```

#### Microkernel OS
- kernel 的程式碼越少越好，更 reliable
- Moves as much from the kernel into **user space**
- Communication is provided by **message passing**
  - modularize 的概念，kernel 負責溝通
- Easier for extending and poring
- 效能更差，因為需要大量 system call、memory copy
```img
microkernel-os.png
```

#### Modular OS Structure
- no need **message passing**
- Most modern OS implement **kernel modules**
  - Uses **object-oriented approach**
  - Each core **component is seperate**
  - Each talks to the others over **known interfaces**
  - Each is **loadable** as needed within the kernel
- Similar to layers but with more flexible
```img
modular-os-structure.png
```


#### Virtual Machine
- A virtual machine takes the **layered** approach to its logical conclusion
  - It treats hardware and the **operating system** kernel as though they were all hardware
- A virtual machine provides an interface **identical to the underlying bare hardware**
  - Each process is provided with a (virtual) copy of the underlying computer
- Difficult to achieve due to **critical instruction**
- critical instruction
  - User space 的執行結果和 Kernel space 的執行結果不一樣
```img
VM.png
```
- Usage
  - provides complete protection of system resources
    - 不同使用者共用一台電腦不會互相影響
  - a mean to solve system compatibility problems
    - 環境問題
  - a perfect vehicle for operating-systems research and development
    - kernel 有 bug 會整個 crash 掉，VM 適合用來測試
  - honeypot
  - a mean to increase resources utilization in **cloud computing**
    - 不過 cloud computing 不一定要 VM

##### Vmware (Full Virtualization)
- Run in **user** mode as an application on top of OS
- Virtual machine believe they are running on bare hardware but **in fact are running inside a user-level application**
- Guest OS 的程式碼不用動
```img
VMware.png
```

##### Para-virtualization: Xen
- Presents guest with system **similar but not identical** to the guest's preffered systems (**Guest must be modified**)
- 有 global manager(master)，可能會比較快，但是 overhead 比較高
```img
Xen.png
```

#### Java Virtual Machine
- Compiled Java programs are **platform-neutral bytecodes** executed by a **Java Virtual Machine** (JVM)
- JVM consists of
  - class loader
  - class verifier
  - runtime interpreter
- **Just-In-Time** (JIT) compilers increase performance
  - reuse 翻譯過的程式碼